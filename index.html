<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Здесь есть только те музыке котрый мне нравиться!!!">
    <meta name="theme-color" content="#1db954">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <title>Музыкальный Плеер</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Переменные для тем */
        :root {
            --primary: #1db954;
            --primary-hover: #1ed760;
            --dark: #121212;
            --dark-secondary: #181818;
            --dark-tertiary: #282828;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
        }
        
        .light-theme {
            --dark: #f5f5f5;
            --dark-secondary: #e5e5e5;
            --dark-tertiary: #d4d4d4;
            --text-primary: #000000;
            --text-secondary: #666666;
        }

        /* Общие стили */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dark);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
            touch-action: manipulation;
        }

        /* Карточки треков и плейлистов */
        .music-card, .playlist-card {
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--dark-secondary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .music-card:hover, .playlist-card:hover {
            transform: translateY(-5px);
            background: var(--dark-tertiary);
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        .music-card:hover .delete-btn, 
        .playlist-card:hover .delete-btn {
            opacity: 1;
        }

        /* Полноэкранные тексты песен */
        .fullscreen-lyrics {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }

        .light-theme .fullscreen-lyrics {
            background: rgba(255, 255, 255, 0.95);
        }

        .fullscreen-lyrics-content {
            flex: 1;
            overflow-y: auto;
            font-size: 1.8rem;
            line-height: 2rem;
            white-space: pre-wrap;
            text-align: center;
            padding: 2rem 1rem;
        }

        .fullscreen-lyrics .lyric-line {
            margin-bottom: 2rem;
            opacity: 0.6;
            transition: all 0.3s ease;
            line-height: 1.4;
        }

        .fullscreen-lyrics .lyric-line.active {
            font-size: 2.2rem;
            opacity: 1;
            color: var(--primary);
            font-weight: 600;
            animation: lyricGlow 0.5s ease-in-out;
        }

        @keyframes lyricGlow {
            0% { transform: scale(1); text-shadow: none; }
            50% { transform: scale(1.1); text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); }
            100% { transform: scale(1); text-shadow: 0 0 5px var(--primary); }
        }

        /* Кнопки управления */
        .theme-toggle-btn, .share-btn, .translation-toggle, 
        .autoplay-toggle, .loop-toggle, .nav-btn, .upload-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--dark-tertiary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .theme-toggle-btn:hover, .share-btn:hover, .translation-toggle:hover, 
        .autoplay-toggle:hover, .loop-toggle:hover, .nav-btn:hover, .upload-btn:hover {
            background: var(--primary);
            transform: scale(1.05);
        }

        .nav-btn {
            padding: 0.75rem;
            background: var(--dark-secondary);
        }

        /* Полноэкранные элементы */
        .close-fullscreen, .fullscreen-toggle {
            background: var(--dark-tertiary);
            color: var(--text-primary);
            border-radius: 50%;
            padding: 0.5rem;
            transition: background-color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .close-fullscreen:hover, .fullscreen-toggle:hover {
            background: var(--primary);
        }

        /* Прогресс-бар и ползунок громкости */
        input[type="range"] {
            -webkit-appearance: none;
            background: var(--dark-tertiary);
            height: 4px;
            border-radius: 2px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Скроллбар */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            padding: 1rem;
        }

        .modal-content {
            background: var(--dark-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content input, .modal-content textarea {
            background: var(--dark-tertiary);
            color: var(--text-primary);
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .file-upload-area {
            border: 2px dashed var(--dark-tertiary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: rgba(29, 185, 84, 0.1);
        }

        .file-upload-area.dragover {
            border-color: var(--primary);
            background: rgba(29, 185, 84, 0.2);
        }

        .file-upload-icon {
            font-size: 2.5rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        /* Уведомление об офлайн-режиме */
        #offline-warning {
            transition: opacity 0.3s ease;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .fullscreen-lyrics .lyric-line {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .fullscreen-lyrics .lyric-line.active {
                font-size: 1.8rem;
            }

            .track-view-container {
                flex-direction: column;
            }

            .track-image-container, .lyrics-container {
                width: 100% !important;
                padding: 0 !important;
            }

            .music-card:hover, .playlist-card:hover {
                transform: none;
            }

            .delete-btn {
                opacity: 1;
            }

            #player {
                padding: 0.5rem;
            }

            #player .container {
                flex-direction: column;
                gap: 0.5rem;
            }

            #player .flex-1 {
                width: 100%;
            }

            #player .ml-4 {
                margin-left: 0;
                width: 100%;
            }

            #player input[type="range"] {
                width: 100%;
            }

            .modal-content {
                padding: 1rem;
            }

            .track-view-container .flex-wrap {
                justify-content: center;
            }

            .track-view-container .flex-wrap > * {
                margin: 0.25rem;
            }
        }

        @media (max-width: 480px) {
            .music-card, .playlist-card {
                width: 100%;
            }

            #playlists-grid, #tracks-grid {
                grid-template-columns: 1fr;
            }

            .track-image-container img {
                width: 200px;
                height: 200px;
            }

            .fullscreen-lyrics-content {
                font-size: 1.4rem;
                padding: 1rem 0.5rem;
            }

            .fullscreen-lyrics .lyric-line {
                margin-bottom: 1rem;
            }

            .fullscreen-lyrics .lyric-line.active {
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body class="text-white">
    <div id="offline-warning" class="fixed top-0 left-0 right-0 bg-yellow-600 text-white text-center p-2 hidden">
        Вы в офлайн-режиме. Некоторые функции могут быть недоступны.
    </div>
    
    <div id="app" class="container mx-auto px-4 py-8 pb-24">
        <!-- Главный экран -->
        <div id="main-view">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold bg-gradient-to-r from-green-400 to-green-600 bg-clip-text text-transparent">
                    Музыкальный Плеер
                </h1>
                <div class="flex items-center gap-4">
                    <button id="upload-btn" onclick="openUploadModal()" class="upload-btn" aria-label="Добавить музыку">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span>Добавить</span>
                    </button>
                    <button id="theme-toggle" class="theme-toggle-btn" aria-label="Переключить тему">
                        <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <span id="theme-text">Светлая тема</span>
                    </button>
                </div>
            </header>
            
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Плейлисты</h2>
                    <button onclick="openCreatePlaylistModal()" class="bg-green-600 px-4 py-2 rounded-full hover:bg-green-700 transition">
                        Создать
                    </button>
                </div>
                <div id="playlists-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>
            
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Популярные треки</h2>
                <div id="tracks-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>
        </div>
        
        <!-- Страница трека -->
        <div id="track-view" class="hidden">
            <button onclick="backToMain()" class="flex items-center text-gray-400 hover:text-white mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Назад
            </button>
            
            <div class="track-view-container flex flex-col md:flex-row gap-8">
                <div class="track-image-container md:w-1/3 flex flex-col items-center">
                    <img id="track-image" src="" alt="Обложка" class="w-64 h-64 md:w-80 md:h-80 rounded-2xl object-cover mb-6 shadow-lg">
                    <h1 id="track-title" class="text-3xl font-bold text-center mb-2"></h1>
                    <h2 id="track-artist" class="text-xl text-gray-400 text-center mb-8"></h2>
                    
                    <div class="flex gap-4 mb-8 flex-wrap justify-center">
                        <button onclick="playPreviousTrack()" class="nav-btn" aria-label="Предыдущий трек">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="19 3 5 12 19 21 19 3"></polygon>
                                <line x1="5" y1="3" x2="5" y2="21"></line>
                            </svg>
                        </button>
                        
                        <button onclick="togglePlay()" class="bg-green-600 px-8 py-3 rounded-full hover:bg-green-700 transition flex items-center" aria-label="Воспроизведение/Пауза">
                            <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                            <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2 hidden">
                                <rect x="6" y="4" width="4" height="16"></rect>
                                <rect x="14" y="4" width="4" height="16"></rect>
                            </svg>
                            <span id="play-text">Играть</span>
                        </button>
                        
                        <button onclick="playNextTrack()" class="nav-btn" aria-label="Следующий трек">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                <line x1="19" y1="3" x2="19" y2="21"></line>
                            </svg>
                        </button>
                        
                        <button id="loop-toggle" onclick="toggleLoop()" class="loop-toggle" aria-label="Переключить режим повтора">
                            <svg id="loop-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 3l-4 4 4 4"></path>
                                <path d="M10 21l4-4-4-4"></path>
                                <path d="M17 3h4v4"></path>
                                <path d="M7 21H3v-4"></path>
                            </svg>
                            <span id="loop-text">Повтор: Выкл</span>
                        </button>
                        
                        <button onclick="openAddToPlaylistModal()" class="bg-gray-600 px-4 py-2 rounded-full hover:bg-gray-700 transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 16" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            В плейлист
                        </button>
                        
                        <button onclick="shareTrack()" class="share-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                            Поделиться
                        </button>
                        
                        <button id="autoplay-toggle" onclick="toggleAutoplay()" class="autoplay-toggle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                                <path d="M21 7v10l-9-5 9-5z"></path>
                                <path d="M12 7v10l-9-5 9-5z"></path>
                            </svg>
                            <span id="autoplay-text">Автовоспроизведение: Вкл</span>
                        </button>
                        
                        <button onclick="confirmDeleteTrack()" class="bg-red-600 px-4 py-2 rounded-full hover:bg-red-700 transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Удалить
                        </button>
                    </div>
                    
                    <div class="w-full mb-8">
                        <div class="flex justify-between text-sm text-gray-400 mb-2">
                            <span id="current-time">00:00</span>
                            <span id="total-time">00:00</span>
                        </div>
                        <input type="range" id="progress-bar" value="0" max="100" class="w-full h-2 rounded-full appearance-none bg-gray-700">
                        <div class="text-sm text-gray-400 mt-2">
                            <span id="remaining-time">Осталось: -00:00</span>
                        </div>
                    </div>
                </div>
                
                <div class="lyrics-container md:w-2/3 md:pl-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-semibold">Текст песни</h3>
                        <div class="flex gap-4">
                            <button id="translation-toggle" onclick="toggleTranslation()" class="translation-toggle hidden">
                                Показать перевод
                            </button>
                            <button id="fullscreen-lyrics-btn" onclick="toggleFullscreenLyrics()" class="bg-gray-700/50 hover:bg-gray-600/50 p-2 rounded-lg transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div id="lyrics-container" class="bg-gray-800/50 rounded-xl p-6 max-h-96 overflow-y-auto"></div>
                    
                    <h3 class="text-2xl font-semibold mt-12 mb-6">Похожие треки</h3>
                    <div id="similar-tracks" class="flex overflow-x-auto gap-6 pb-4"></div>
                </div>
            </div>
        </div>
        
        <!-- Полноэкранные тексты -->
        <div id="fullscreen-lyrics" class="fullscreen-lyrics hidden">
            <button class="close-fullscreen" onclick="toggleFullscreenLyrics()" aria-label="Закрыть полноэкранный режим">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            
            <div class="fullscreen-lyrics-content" id="fullscreen-lyrics-content"></div>
            
            <div class="fullscreen-controls flex justify-center gap-4">
                <button onclick="togglePlay()" class="bg-green-600 px-6 py-2 rounded-full hover:bg-green-700 transition text-lg font-semibold">
                    <span id="fullscreen-play-text">Пауза</span>
                </button>
                <button id="fullscreen-translation-toggle" onclick="toggleTranslation()" class="translation-toggle hidden">
                    Показать перевод
                </button>
            </div>
            
            <button class="fullscreen-toggle" onclick="toggleFullscreenLyrics()" aria-label="Свернуть полноэкранный режим">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                </svg>
                Свернуть
            </button>
        </div>
        
        <!-- Панель плеера -->
        <div id="player" class="fixed bottom-0 left-0 right-0 bg-gray-800 p-4 hidden border-t border-gray-700">
            <div class="container mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-4 flex-1 min-w-0">
                    <img id="player-image" src="" alt="Обложка" class="w-12 h-12 object-cover rounded-lg">
                    <div class="truncate">
                        <h3 id="player-title" class="font-semibold truncate"></h3>
                        <p id="player-artist" class="text-sm text-gray-400 truncate"></p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 ml-4">
                    <div class="flex text-sm text-gray-400 gap-2">
                        <span id="player-current-time">00:00</span>
                        <span>/</span>
                        <span id="player-total-time">00:00</span>
                        <span id="player-remaining-time" class="ml-2">Осталось: -00:00</span>
                    </div>
                    
                    <button onclick="playPreviousTrack()" class="nav-btn" aria-label="Предыдущий трек">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="19 3 5 12 19 21 19 3"></polygon>
                            <line x1="5" y1="3" x2="5" y2="21"></line>
                        </svg>
                    </button>
                    
                    <button onclick="togglePlay()" class="bg-green-600 p-3 rounded-full hover:bg-green-700 transition flex-shrink-0" aria-label="Воспроизведение/Пауза">
                        <svg id="player-play-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <svg id="player-pause-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hidden">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                    </button>
                    
                    <button onclick="playNextTrack()" class="nav-btn" aria-label="Следующий трек">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            <line x1="19" y1="3" x2="19" y2="21"></line>
                        </svg>
                    </button>
                    
                    <button id="player-loop-toggle" onclick="toggleLoop()" class="loop-toggle" aria-label="Переключить режим повтора">
                        <svg id="player-loop-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 3l-4 4 4 4"></path>
                            <path d="M10 21l4-4-4-4"></path>
                            <path d="M17 3h4v4"></path>
                            <path d="M7 21H3v-4"></path>
                        </svg>
                        <span id="player-loop-text">Повтор: Выкл</span>
                    </button>
                    
                    <input type="range" id="volume-control" value="50" max="100" class="w-20 md:w-24 h-2 rounded-full appearance-none bg-gray-700">
                </div>
            </div>
        </div>
        
        <!-- Модальные окна -->
        <div id="create-playlist-modal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4">Создать плейлист</h2>
                <input id="playlist-name-input" type="text" placeholder="Название плейлиста" maxlength="50">
                <div class="flex justify-end mt-4">
                    <button onclick="createPlaylist()" class="bg-green-600 px-4 py-2 rounded-full hover:bg-green-700 transition">Создать</button>
                    <button onclick="closeCreatePlaylistModal()" class="bg-gray-600 px-4 py-2 rounded-full hover:bg-gray-700 transition">Отмена</button>
                </div>
            </div>
        </div>
        
        <div id="add-to-playlist-modal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4">Добавить в плейлист</h2>
                <div id="playlists-list" class="mb-4"></div>
                <div class="flex justify-end">
                    <button onclick="closeAddToPlaylistModal()" class="bg-gray-600 px-4 py-2 rounded-full hover:bg-gray-700 transition">Закрыть</button>
                </div>
            </div>
        </div>
        
        <div id="share-modal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4">Поделиться треком</h2>
                <div id="share-options" class="mb-4">
                    <div class="flex items-center gap-2 bg-gray-700/50 p-2 rounded-lg cursor-pointer hover:bg-gray-600/50" onclick="copyTrackUrl()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        Копировать ссылку
                    </div>
                    <div class="flex items-center gap-2 bg-gray-700/50 p-2 rounded-lg cursor-pointer hover:bg-gray-600/50" onclick="shareToTwitter()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.2 0 3-1.2 3-1.2z"></path>
                        </svg>
                        Twitter/X
                    </div>
                    <div class="flex items-center gap-2 bg-gray-700/50 p-2 rounded-lg cursor-pointer hover:bg-gray-600/50" onclick="shareToWhatsApp()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 7v10l-9-5 9-5z"></path>
                            <path d="M12 7v10l-9-5 9-5z"></path>
                        </svg>
                        WhatsApp
                    </div>
                    <div class="flex items-center gap-2 bg-gray-700/50 p-2 rounded-lg cursor-pointer hover:bg-gray-600/50" onclick="shareToTelegram()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                        Telegram
                    </div>
                </div>
                <div id="manual-copy" class="hidden mb-4">
                    <p class="mb-2">Скопируйте ссылку вручную:</p>
                    <input id="manual-copy-id" type="text" readonly class="w-full">
                    <button onclick="selectManualCopyText()" class="bg-green-600 px-4 py-2 rounded-full hover:bg-green-700 transition mt-2">Выделить</button>
                </div>
                <div class="flex justify-end">
                    <button onclick="closeShareModal()" class="bg-gray-600 px-4 py-2 rounded-full hover:bg-gray-700 transition">Закрыть</button>
                </div>
            </div>
        </div>
        
        <div id="upload-modal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4">Добавить новый трек</h2>
                <form id="upload-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Название трека *</label>
                            <input type="text" id="track-title-input" placeholder="Введите название трека" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Исполнитель *</label>
                            <input type="text" id="track-artist-input" placeholder="Введите имя исполнителя" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Продолжительность (секунды) *</label>
                            <input type="number" id="track-duration-input" placeholder="Например: 180" min="1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Ссылка на изображение (опционально)</label>
                            <input type="url" id="image-url-input" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Ссылка на аудио *</label>
                        <input type="url" id="audio-url-input" placeholder="https://example.com/audio.mp3" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Текст песни</label>
                        <textarea id="track-lyrics-input" placeholder="Введите текст песни (по одной строке на каждую строчку песни)" rows="4"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Перевод (опционально)</label>
                        <textarea id="track-translation-input" placeholder="Введите перевод текста песни" rows="4"></textarea>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="closeUploadModal()" class="bg-gray-600 px-4 py-2 rounded-full hover:bg-gray-700 transition">Отмена</button>
                        <button type="submit" class="bg-green-600 px-4 py-2 rounded-full hover:bg-green-700 transition">Добавить</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="confirm-delete-modal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4">Удалить трек</h2>
                <p>Вы уверены, что хотите удалить этот трек? Это действие нельзя отменить.</p>
                <div class="flex justify-end mt-4 gap-4">
                    <button onclick="closeDeleteModal()" class="bg-gray-600 px-4 py-2 rounded-full hover:bg-gray-700 transition">Отмена</button>
                    <button onclick="deleteTrack()" class="bg-red-600 px-4 py-2 rounded-full hover:bg-red-700 transition">Удалить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Данные треков
        let tracks = {
            '1': {
                title: 'No one noticed',
                artist: 'The Marias',
                image: 'https://avatars.mds.yandex.net/i?id=a3b036bcdd2d49eb7a42cd3f220f0d15f0f1af8f-5180074-images-thumbs&n=13',
                audio: 'https://files.catbox.moe/2nqd32.mp3',
                duration: 204,
                lyrics: [
                    { text: "Maybe I", time: 0 },
                    { text: "Lost my mind", time: 5 },
                    { text: "No one noticed", time: 10 },
                ],
                translations: [
                    { text: "Может быть, я", time: 0 },
                    { text: "Сошла с ума", time: 5 },
                    { text: "Никто не заметил", time: 10 },
                ],
                similar: ['2', '3', '4']
            },
            '2': {
                title: 'Forever',
                artist: 'IlyTOMMY',
                image: 'https://avatars.mds.yandex.net/i?id=e10d9bfd4cd146262fcaaaa8c938c7d52a42cf89-12421984-images-thumbs&n=13',
                audio: 'https://files.catbox.moe/iumh1z.mp3',
                duration: 103,
                lyrics: [
                    { text: "I want you to live, I want that more than anything in this world (forever in my mind, only you)", time: 5 },
                    { text: "I want you to fight like hell to stay with us (the pieces in my life go away with you)", time: 10 },
                    { text: "With everybody else, i know it might not be what you want (forever in my mind, only you)", time: 17 },
                ],
                translations: [
                    { text: "Я хочу, чтобы ты жил(а), я хочу этого больше всего на свете (навсегда в моих мыслях — только ты)", time: 5 },
                    { text: "Я хочу, чтобы ты боролся изо всех сил, чтобы остаться с нами (части моей жизни уходят вместе с тобой)", time: 10 },
                    { text: "Со всеми остальными... Я знаю, это может быть не то, чего ты хочешь (навсегда в моих мыслях — только ты)", time: 17 },
                    { text: "Может быть, тебе слишком тяжело продолжать бороться (части моей жизни уходят вместе с тобой)", time: 21 },
                ],
                similar: ['3', '23', '4']
            },
            '3': {
                title: 'Сердце',
                artist: 'Passmurny',
                image: 'https://avatars.mds.yandex.net/i?id=e946426773349bb7f5f56c5e50ce888a-3979407-images-thumbs&n=13',
                audio: 'https://files.catbox.moe/883589.mp3',
                duration: 145,
                lyrics: [
                    { text: "Ты - мое сердце, моя душа", time: 0 },
                    { text: "Ты - моя жизнь, ты - моя страсть", time: 5 },
                    { text: "Без тебя я не могу", time: 10 },
                ],
                translations: [],
                similar: ['4', '5', '1']
            },
            '4': {
                title: 'Thinking about you',
                artist: 'Keepitinside',
                image: 'https://avatars.mds.yandex.net/i?id=e74153a916c8406af9b56341bbee38941e4fba58-4252773-images-thumbs&n=13',
                audio: 'https://files.catbox.moe/f9189h.mp3',
                duration: 158,
                lyrics: [
                    { text: "I'm thinking about you", time: 0 },
                    { text: "Every single day and night", time: 5 },
                    { text: "Can't get you out of my mind", time: 10 },
                ],
                translations: [
                    { text: "Я думаю о тебе", time: 0 },
                    { text: "Каждый день и ночь", time: 5 },
                    { text: "Не могу выкинуть тебя из головы", time: 10 },
                ],
                similar: ['5', '6', '2']
            },
            '5': {
                title: 'Ocean',
                artist: 'Elsa & Emilie',
                image: 'https://avatars.mds.yandex.net/i?id=b1dc664f35c06330156f8621bd3b1771272c94fd-5016797-images-thumbs&n=13',
                audio: 'https://files.catbox.moe/18218p.mp3',
                duration: 165,
                lyrics: [
                    { text: "Like the ocean deep", time: 0 },
                    { text: "My love for you will keep", time: 5 },
                    { text: "Growing every day", time: 10 },
                ],
                translations: [
                    { text: "Как глубокий океан", time: 0 },
                    { text: "Моя любовь к тебе будет", time: 5 },
                    { text: "Расти каждый день", time: 10 },
                ],
                similar: ['6', '7', '4']
            }
        };

        // Сохраняем треки в localStorage при первой загрузке
        if (!localStorage.getItem('tracks')) {
            localStorage.setItem('tracks', JSON.stringify(tracks));
        } else {
            tracks = JSON.parse(localStorage.getItem('tracks'));
        }

        // Данные плейлистов
        const predefinedPlaylists = {
            'p1': { name: 'Поп', trackIds: ['1', '2'] },
            'p2': { name: 'Русский', trackIds: ['3', '4'] },
            'p3': { name: 'Английский', trackIds: ['1', '2', '4', '5'] },
        };

        // Глобальные переменные
        let userPlaylists = JSON.parse(localStorage.getItem('userPlaylists') || '{}');
        let currentTrackId = null;
        let currentPlaylistId = null;
        let isPlaying = false;
        let currentLyricIndex = -1;
        let isFullscreenLyrics = false;
        let showTranslation = false;
        let isAutoplayEnabled = localStorage.getItem('autoplay') !== 'false';
        let loopMode = localStorage.getItem('loopMode') || 'none';
        const audioPlayer = new Audio();
        let nextCustomTrackId = 1000; // Начинаем с 1000 для пользовательских треков
        let trackToDelete = null;

        // Вспомогательные функции
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatRemainingTime(seconds, totalDuration) {
            const remaining = totalDuration - seconds;
            return `Осталось: -${formatTime(remaining)}`;
        }

        function getTrackUrl(trackId) {
            const baseUrl = window.location.origin || 'http://localhost';
            return `${baseUrl}${window.location.pathname}?track=${trackId}`;
        }

        // Управление воспроизведением
        function togglePlay() {
            const track = tracks[currentTrackId];
            if (!track) return;
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                if (audioPlayer.src !== track.audio) {
                    audioPlayer.src = track.audio;
                    audioPlayer.currentTime = 0;
                }
                audioPlayer.play().catch(e => console.error('Ошибка воспроизведения:', e));
            }
            isPlaying = !isPlaying;
            updatePlayButton();
            updateFullscreenPlayButton();
        }

        function playNextTrack() {
            if (!isAutoplayEnabled && loopMode === 'none') return;
            const track = tracks[currentTrackId];
            if (!track) return;
            
            if (loopMode === 'track') {
                openTrack(currentTrackId, currentPlaylistId);
                togglePlay();
                return;
            }
            
            if (currentPlaylistId && (loopMode === 'playlist' || isAutoplayEnabled)) {
                const playlist = {...predefinedPlaylists, ...userPlaylists}[currentPlaylistId];
                if (!playlist) return;
                
                const currentIndex = playlist.trackIds.indexOf(currentTrackId);
                let nextIndex = currentIndex + 1;
                
                if (nextIndex >= playlist.trackIds.length) {
                    nextIndex = loopMode === 'playlist' ? 0 : -1;
                }
                
                if (nextIndex >= 0 && tracks[playlist.trackIds[nextIndex]]) {
                    openTrack(playlist.trackIds[nextIndex], currentPlaylistId);
                    togglePlay();
                }
                return;
            }
            
            if (isAutoplayEnabled && track.similar && track.similar.length > 0) {
                const nextTrackId = track.similar[0];
                if (nextTrackId && tracks[nextTrackId]) {
                    openTrack(nextTrackId);
                    togglePlay();
                }
            }
        }

        function playPreviousTrack() {
            const track = tracks[currentTrackId];
            if (!track) return;
            
            if (currentPlaylistId) {
                const playlist = {...predefinedPlaylists, ...userPlaylists}[currentPlaylistId];
                if (!playlist) return;
                
                const currentIndex = playlist.trackIds.indexOf(currentTrackId);
                let prevIndex = currentIndex - 1;
                
                if (prevIndex < 0) {
                    prevIndex = loopMode === 'playlist' ? playlist.trackIds.length - 1 : -1;
                }
                
                if (prevIndex >= 0 && tracks[playlist.trackIds[prevIndex]]) {
                    openTrack(playlist.trackIds[prevIndex], currentPlaylistId);
                    togglePlay();
                }
                return;
            }
            
            if (track.similar && track.similar.length > 0) {
                const prevTrackId = track.similar[track.similar.length - 1];
                if (prevTrackId && tracks[prevTrackId]) {
                    openTrack(prevTrackId);
                    togglePlay();
                }
            }
        }

        function toggleLoop() {
            loopMode = loopMode === 'none' ? 'track' : loopMode === 'track' ? 'playlist' : 'none';
            localStorage.setItem('loopMode', loopMode);
            updateLoopButton();
        }

        function updateLoopButton() {
            const loopText = document.getElementById('loop-text');
            const playerLoopText = document.getElementById('player-loop-text');
            const text = `Повтор: ${loopMode === 'none' ? 'Выкл' : loopMode === 'track' ? 'Трек' : 'Плейлист'}`;
            if (loopText) loopText.textContent = text;
            if (playerLoopText) playerLoopText.textContent = text;
        }

        // Обновление интерфейса
        function updatePlayButton() {
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const playText = document.getElementById('play-text');
            const playerPlayIcon = document.getElementById('player-play-icon');
            const playerPauseIcon = document.getElementById('player-pause-icon');
            
            if (isPlaying) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                playText.textContent = 'Пауза';
                playerPlayIcon.classList.add('hidden');
                playerPauseIcon.classList.remove('hidden');
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                playText.textContent = 'Играть';
                playerPlayIcon.classList.remove('hidden');
                playerPauseIcon.classList.add('hidden');
            }
        }

        function updateFullscreenPlayButton() {
            const fullscreenText = document.getElementById('fullscreen-play-text');
            if (fullscreenText) {
                fullscreenText.textContent = isPlaying ? 'Пауза' : 'Играть';
            }
        }

        function updatePlayer() {
            const track = tracks[currentTrackId];
            if (!track) return;
            
            document.getElementById('player-image').src = track.image;
            document.getElementById('player-title').textContent = track.title;
            document.getElementById('player-artist').textContent = track.artist;
        }

        function updateLyrics() {
            const track = tracks[currentTrackId];
            if (!track || !track.lyrics) return;
            
            const currentTime = audioPlayer.currentTime;
            const displayLyrics = showTranslation && track.translations ? track.translations : track.lyrics;
            const lyrics = document.querySelectorAll('#lyrics-container .lyric-line');
            const fullscreenLyrics = document.querySelectorAll('#fullscreen-lyrics-content .lyric-line');
            
            let newIndex = -1;
            for (let i = 0; i < displayLyrics.length; i++) {
                if (currentTime >= displayLyrics[i].time) {
                    newIndex = i;
                } else {
                    break;
                }
            }
            
            if (newIndex !== currentLyricIndex) {
                if (lyrics[currentLyricIndex]) {
                    lyrics[currentLyricIndex].classList.remove('active');
                    lyrics[currentLyricIndex].classList.add('opacity-60');
                }
                
                if (fullscreenLyrics[currentLyricIndex]) {
                    fullscreenLyrics[currentLyricIndex].classList.remove('active');
                }
                
                currentLyricIndex = newIndex;
                
                if (lyrics[currentLyricIndex]) {
                    lyrics[currentLyricIndex].classList.add('active');
                    lyrics[currentLyricIndex].classList.remove('opacity-60');
                    if (!isFullscreenLyrics) {
                        lyrics[currentLyricIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                if (fullscreenLyrics[currentLyricIndex]) {
                    fullscreenLyrics[currentLyricIndex].classList.add('active');
                    if (isFullscreenLyrics) {
                        fullscreenLyrics[currentLyricIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        }

        // Навигация по интерфейсу
        function openTrack(trackId, playlistId = null) {
            const track = tracks[trackId];
            if (!track) return;
            
            currentTrackId = trackId;
            currentPlaylistId = playlistId;
            showTranslation = false;
            currentLyricIndex = -1;
            
            document.getElementById('track-image').src = track.image;
            document.getElementById('track-title').textContent = track.title;
            document.getElementById('track-artist').textContent = track.artist;
            document.getElementById('total-time').textContent = formatTime(track.duration);
            document.getElementById('remaining-time').textContent = formatRemainingTime(0, track.duration);
            document.getElementById('player-total-time').textContent = formatTime(track.duration);
            document.getElementById('player-remaining-time').textContent = formatRemainingTime(0, track.duration);
            
            const lyricsContainer = document.getElementById('lyrics-container');
            lyricsContainer.innerHTML = '';
            
            const displayLyrics = track.translations && showTranslation ? track.translations : track.lyrics;
            if (displayLyrics && displayLyrics.length > 0) {
                displayLyrics.forEach(line => {
                    const div = document.createElement('div');
                    div.className = 'lyric-line mb-4 transition-opacity duration-300 opacity-60';
                    div.textContent = line.text;
                    lyricsContainer.appendChild(div);
                });
            } else {
                const div = document.createElement('div');
                div.className = 'text-gray-500 italic';
                div.textContent = 'Текст песни отсутствует';
                lyricsContainer.appendChild(div);
            }
            
            const translationToggle = document.getElementById('translation-toggle');
            translationToggle.classList.toggle('hidden', !track.translations || track.translations.length === 0);
            translationToggle.textContent = showTranslation ? 'Скрыть перевод' : 'Показать перевод';
            
            const similarContainer = document.getElementById('similar-tracks');
            similarContainer.innerHTML = '';
            
            if (track.similar && track.similar.length > 0) {
                track.similar.forEach(similarId => {
                    const similarTrack = tracks[similarId];
                    if (!similarTrack) return;
                    
                    const div = document.createElement('div');
                    div.className = 'music-card flex flex-col items-center flex-shrink-0 w-24';
                    div.onclick = () => openTrack(similarId);
                    div.innerHTML = `
                        <div class="w-24 h-24 rounded-full overflow-hidden">
                            <img src="${similarTrack.image}" alt="${similarTrack.title}" class="w-full h-full object-cover">
                        </div>
                        <h4 class="mt-3 font-medium text-center truncate w-full">${similarTrack.title}</h4>
                        <p class="text-sm text-gray-400 text-center truncate w-full">${similarTrack.artist}</p>
                    `;
                    similarContainer.appendChild(div);
                });
            } else {
                const div = document.createElement('div');
                div.className = 'text-gray-500 italic';
                div.textContent = 'Похожие треки отсутствуют';
                similarContainer.appendChild(div);
            }
            
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('track-view').classList.remove('hidden');
            document.getElementById('player').classList.remove('hidden');
            
            if (document.getElementById('playlist-view')) {
                document.getElementById('playlist-view').classList.add('hidden');
            }
            
            updatePlayer();
            updateAutoplayButton();
            updateLoopButton();
            document.getElementById('progress-bar').value = 0;
            document.getElementById('current-time').textContent = '00:00';
            document.getElementById('player-current-time').textContent = '00:00';
            
            if (isPlaying) {
                togglePlay();
            }
            
            window.scrollTo(0, 0);
        }

        function backToMain() {
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('track-view').classList.add('hidden');
            
            if (document.getElementById('playlist-view')) {
                document.getElementById('playlist-view').classList.add('hidden');
            }
            
            currentPlaylistId = null;
            
            if (isFullscreenLyrics) {
                toggleFullscreenLyrics();
            }
        }

        function toggleFullscreenLyrics() {
            isFullscreenLyrics = !isFullscreenLyrics;
            const fullscreenLyrics = document.getElementById('fullscreen-lyrics');
            const fullscreenContent = document.getElementById('fullscreen-lyrics-content');
            
            if (isFullscreenLyrics) {
                fullscreenContent.innerHTML = '';
                const track = tracks[currentTrackId];
                
                if (track && track.lyrics) {
                    const displayLyrics = showTranslation && track.translations ? track.translations : track.lyrics;
                    displayLyrics.forEach((line, index) => {
                        const div = document.createElement('div');
                        div.className = `lyric-line ${index === currentLyricIndex ? 'active' : ''}`;
                        div.textContent = line.text;
                        fullscreenContent.appendChild(div);
                    });
                }
                
                const fullscreenTranslationToggle = document.getElementById('fullscreen-translation-toggle');
                fullscreenTranslationToggle.classList.toggle('hidden', !tracks[currentTrackId]?.translations || tracks[currentTrackId]?.translations.length === 0);
                fullscreenTranslationToggle.textContent = showTranslation ? 'Скрыть перевод' : 'Показать перевод';
                
                fullscreenLyrics.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                setTimeout(() => {
                    const activeLine = fullscreenContent.querySelector('.lyric-line.active');
                    if (activeLine) {
                        activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
                
                updateFullscreenPlayButton();
            } else {
                fullscreenLyrics.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        function toggleTranslation() {
            showTranslation = !showTranslation;
            const track = tracks[currentTrackId];
            if (!track) return;
            
            const lyricsContainer = document.getElementById('lyrics-container');
            lyricsContainer.innerHTML = '';
            
            const displayLyrics = showTranslation && track.translations ? track.translations : track.lyrics;
            
            if (displayLyrics && displayLyrics.length > 0) {
                displayLyrics.forEach((line, index) => {
                    const div = document.createElement('div');
                    div.className = `lyric-line mb-4 transition-opacity duration-300 ${index === currentLyricIndex ? '' : 'opacity-60'}`;
                    div.textContent = line.text;
                    lyricsContainer.appendChild(div);
                });
            } else {
                const div = document.createElement('div');
                div.className = 'text-gray-500 italic';
                div.textContent = 'Перевод отсутствует';
                lyricsContainer.appendChild(div);
            }
            
            if (isFullscreenLyrics) {
                const fullscreenContent = document.getElementById('fullscreen-lyrics-content');
                fullscreenContent.innerHTML = '';
                
                if (displayLyrics && displayLyrics.length > 0) {
                    displayLyrics.forEach((line, index) => {
                        const div = document.createElement('div');
                        div.className = `lyric-line ${index === currentLyricIndex ? 'active' : ''}`;
                        div.textContent = line.text;
                        fullscreenContent.appendChild(div);
                    });
                }
                
                setTimeout(() => {
                    const activeLine = fullscreenContent.querySelector('.lyric-line.active');
                    if (activeLine) {
                        activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            const translationToggle = document.getElementById('translation-toggle');
            const fullscreenTranslationToggle = document.getElementById('fullscreen-translation-toggle');
            const buttonText = showTranslation ? 'Скрыть перевод' : 'Показать перевод';
            
            translationToggle.textContent = buttonText;
            fullscreenTranslationToggle.textContent = buttonText;
        }

        // Управление плейлистами
        function updatePlaylistsGrid() {
            const grid = document.getElementById('playlists-grid');
            grid.innerHTML = '';
            
            const allPlaylists = { ...predefinedPlaylists, ...userPlaylists };
            Object.entries(allPlaylists).forEach(([id, playlist]) => {
                const div = document.createElement('div');
                div.className = 'playlist-card';
                div.onclick = () => openPlaylist(id);
                
                const coverImage = playlist.trackIds[0] ? tracks[playlist.trackIds[0]].image : 'https://via.placeholder.com/150';
                
                div.innerHTML = `
                    <img src="${coverImage}" alt="${playlist.name}" class="w-full aspect-square object-cover">
                    <div class="p-3">
                        <h3 class="font-medium truncate">${playlist.name}</h3>
                        <p class="text-sm text-gray-400 truncate">${playlist.trackIds.length} треков</p>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function openPlaylist(playlistId) {
            const playlist = { ...predefinedPlaylists, ...userPlaylists }[playlistId];
            if (!playlist) return;
            
            document.getElementById('main-view').classList.add('hidden');
            
            let playlistView = document.getElementById('playlist-view');
            if (!playlistView) {
                playlistView = document.createElement('div');
                playlistView.id = 'playlist-view';
                document.getElementById('app').appendChild(playlistView);
            }
            
            playlistView.innerHTML = `
                <button onclick="backToMain()" class="flex items-center text-gray-400 hover:text-white mb-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Назад
                </button>
                <h2 class="text-2xl font-semibold mb-4">${playlist.name}</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    ${playlist.trackIds.map(trackId => {
                        const track = tracks[trackId];
                        if (!track) return '';
                        
                        return `
                            <div class="music-card" onclick="openTrack('${trackId}', '${playlistId}')">
                                <img src="${track.image}" alt="${track.title}" class="w-full aspect-square object-cover">
                                <div class="p-3">
                                    <h3 class="font-medium truncate">${track.title}</h3>
                                    <p class="text-sm text-gray-400 truncate">${track.artist}</p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            playlistView.classList.remove('hidden');
        }

        function openCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.remove('hidden');
            document.getElementById('playlist-name-input').focus();
        }

        function closeCreatePlaylistModal() {
            document.getElementById('create-playlist-modal').classList.add('hidden');
            document.getElementById('playlist-name-input').value = '';
        }

        function createPlaylist() {
            const name = document.getElementById('playlist-name-input').value.trim();
            if (!name) return alert('Введите название плейлиста');
            
            const playlistId = 'u' + Date.now();
            userPlaylists[playlistId] = { name, trackIds: [] };
            localStorage.setItem('userPlaylists', JSON.stringify(userPlaylists));
            
            updatePlaylistsGrid();
            closeCreatePlaylistModal();
        }

        function openAddToPlaylistModal() {
            const playlistsList = document.getElementById('playlists-list');
            playlistsList.innerHTML = '';
            
            const allPlaylists = { ...predefinedPlaylists, ...userPlaylists };
            Object.entries(allPlaylists).forEach(([id, playlist]) => {
                const div = document.createElement('div');
                div.className = 'p-2 hover:bg-gray-700/50 cursor-pointer rounded';
                div.textContent = playlist.name;
                div.onclick = () => addToPlaylist(id);
                playlistsList.appendChild(div);
            });
            
            document.getElementById('add-to-playlist-modal').classList.remove('hidden');
        }

        function closeAddToPlaylistModal() {
            document.getElementById('add-to-playlist-modal').classList.add('hidden');
        }

        function addToPlaylist(playlistId) {
            if (!currentTrackId) return;
            
            if (userPlaylists[playlistId]) {
                if (!userPlaylists[playlistId].trackIds.includes(currentTrackId)) {
                    userPlaylists[playlistId].trackIds.push(currentTrackId);
                    localStorage.setItem('userPlaylists', JSON.stringify(userPlaylists));
                }
            }
            
            closeAddToPlaylistModal();
            alert('Трек добавлен в плейлист');
        }

        // Удаление треков
        function confirmDeleteTrack() {
            trackToDelete = currentTrackId;
            document.getElementById('confirm-delete-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('confirm-delete-modal').classList.add('hidden');
            trackToDelete = null;
        }

        function deleteTrack() {
            if (!trackToDelete) return;
            
            // Удаляем трек из всех плейлистов
            const allPlaylists = { ...predefinedPlaylists, ...userPlaylists };
            Object.keys(allPlaylists).forEach(playlistId => {
                const playlist = allPlaylists[playlistId];
                const index = playlist.trackIds.indexOf(trackToDelete);
                if (index !== -1) {
                    playlist.trackIds.splice(index, 1);
                    
                    // Обновляем пользовательские плейлисты в localStorage
                    if (playlistId.startsWith('u')) {
                        userPlaylists[playlistId] = playlist;
                    }
                }
            });
            
            // Удаляем трек из основного списка
            delete tracks[trackToDelete];
            
            // Обновляем похожие треки в других треках
            Object.keys(tracks).forEach(trackId => {
                const track = tracks[trackId];
                if (track.similar) {
                    const index = track.similar.indexOf(trackToDelete);
                    if (index !== -1) {
                        track.similar.splice(index, 1);
                    }
                }
            });
            
            // Сохраняем изменения
            localStorage.setItem('tracks', JSON.stringify(tracks));
            localStorage.setItem('userPlaylists', JSON.stringify(userPlaylists));
            
            // Обновляем интерфейс
            updatePlaylistsGrid();
            updateTracksGrid();
            
            // Закрываем модальное окно и возвращаемся на главную
            closeDeleteModal();
            backToMain();
            
            // Останавливаем воспроизведение, если удаляемый трек играл
            if (currentTrackId === trackToDelete) {
                audioPlayer.pause();
                isPlaying = false;
                updatePlayButton();
                document.getElementById('player').classList.add('hidden');
            }
            
            alert('Трек успешно удален');
        }

        // Поделиться треком
        function shareTrack() {
            if (!currentTrackId) return;
            
            const track = tracks[currentTrackId];
            if (!track) return;
            
            const url = getTrackUrl(currentTrackId);
            const text = `Слушаю "${track.title}" от ${track.artist} на Музыкальном Плеере!`;
            
            if (navigator.share && window.location.protocol === 'https:') {
                navigator.share({ title: track.title, text, url })
                    .catch(() => openShareModal(url, text));
            } else {
                openShareModal(url, text);
            }
        }

        function openShareModal(url, text) {
            document.getElementById('share-modal').classList.remove('hidden');
            
            const manualCopy = document.getElementById('manual-copy');
            const manualCopyInput = document.getElementById('manual-copy-id');
            
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                manualCopy.classList.remove('hidden');
                manualCopyInput.value = url;
            } else {
                manualCopy.classList.add('hidden');
            }
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
        }

        function selectManualCopyText() {
            const input = document.getElementById('manual-copy-id');
            input.select();
            alert('Ссылка выделена. Скопируйте её с помощью Ctrl+C.');
        }

        function copyTrackUrl() {
            if (!currentTrackId) return;
            
            const url = getTrackUrl(currentTrackId);
            
            if (window.location.protocol === 'https:' || window.location.hostname === 'localhost') {
                navigator.clipboard.writeText(url)
                    .then(() => {
                        alert('Ссылка скопирована!');
                        closeShareModal();
                    })
                    .catch(() => {
                        alert('Не удалось скопировать. Скопируйте вручную.');
                        document.getElementById('manual-copy').classList.remove('hidden');
                        document.getElementById('manual-copy-id').value = url;
                    });
            } else {
                alert('Копирование недоступно. Скопируйте вручную.');
                document.getElementById('manual-copy').classList.remove('hidden');
                document.getElementById('manual-copy-id').value = url;
            }
        }

        function shareToTwitter() {
            const track = tracks[currentTrackId];
            const url = getTrackUrl(currentTrackId);
            const text = `Слушаю "${track.title}" от ${track.artist} на Музыкальном Плеере!`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
            closeShareModal();
        }

        function shareToWhatsApp() {
            const track = tracks[currentTrackId];
            const url = getTrackUrl(currentTrackId);
            const text = `Слушаю "${track.title}" от ${track.artist} на Музыкальном Плеере! ${url}`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
            closeShareModal();
        }

        function shareToTelegram() {
            const track = tracks[currentTrackId];
            const url = getTrackUrl(currentTrackId);
            const text = `Слушаю "${track.title}" от ${track.artist} на Музыкальном Плеере! ${url}`;
            window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
            closeShareModal();
        }

        function toggleAutoplay() {
            isAutoplayEnabled = !isAutoplayEnabled;
            localStorage.setItem('autoplay', isAutoplayEnabled);
            updateAutoplayButton();
        }

        function updateAutoplayButton() {
            const autoplayText = document.getElementById('autoplay-text');
            if (autoplayText) {
                autoplayText.textContent = `Автовоспроизведение: ${isAutoplayEnabled ? 'Вкл' : 'Выкл'}`;
            }
        }

        // Темы
        function toggleTheme() {
            const body = document.body;
            const isLightTheme = body.classList.contains('light-theme');
            body.classList.toggle('light-theme');
            
            const themeText = document.getElementById('theme-text');
            const themeIcon = document.getElementById('theme-icon');
            
            if (isLightTheme) {
                themeText.textContent = 'Светлая тема';
                themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
                localStorage.setItem('theme', 'dark');
            } else {
                themeText.textContent = 'Темная тема';
                themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
                localStorage.setItem('theme', 'light');
            }
        }

        // Загрузка трека
        function openUploadModal() {
            document.getElementById('upload-modal').classList.remove('hidden');
            document.getElementById('track-title-input').focus();
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').classList.add('hidden');
            document.getElementById('upload-form').reset();
        }

        function processLyrics(text) {
            if (!text) return [];
            return text.split('\n').map((line, index) => ({
                text: line.trim(),
                time: index * 5 // Примерное время для каждой строки
            })).filter(line => line.text.length > 0);
        }

        function createTrackId() {
            return 'c' + (nextCustomTrackId++);
        }

        function addTrackToLibrary(trackData) {
            const trackId = createTrackId();
            const duration = trackData.duration || Math.ceil(trackData.lyrics.length * 5); // Используем указанную продолжительность
            const image = trackData.image || 'https://via.placeholder.com/150';
            const similar = Object.keys(tracks).slice(0, 5); // Первые 5 треков как похожие
            
            tracks[trackId] = {
                title: trackData.title,
                artist: trackData.artist,
                image: image,
                audio: trackData.audioUrl,
                duration: duration,
                lyrics: trackData.lyrics,
                translations: trackData.translation ? processLyrics(trackData.translation) : [],
                similar: similar
            };
            
            // Сохраняем треки в localStorage
            localStorage.setItem('tracks', JSON.stringify(tracks));
            
            // Добавляем в первый плейлист по умолчанию
            const allPlaylists = { ...predefinedPlaylists, ...userPlaylists };
            const firstPlaylistId = Object.keys(allPlaylists)[0];
            
            if (firstPlaylistId) {
                allPlaylists[firstPlaylistId].trackIds.push(trackId);
                
                if (firstPlaylistId.startsWith('u')) {
                    userPlaylists[firstPlaylistId] = allPlaylists[firstPlaylistId];
                    localStorage.setItem('userPlaylists', JSON.stringify(userPlaylists));
                }
            }
            
            // Обновляем интерфейс
            updatePlaylistsGrid();
            updateTracksGrid();
            
            return trackId;
        }

        function updateTracksGrid() {
            const container = document.getElementById('tracks-grid');
            container.innerHTML = '';
            
            const trackIds = Object.keys(tracks);
            trackIds.forEach(trackId => {
                const track = tracks[trackId];
                if (!track) return;
                
                const div = document.createElement('div');
                div.className = 'music-card';
                div.onclick = () => openTrack(trackId);
                
                // Добавляем кнопку удаления
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    trackToDelete = trackId;
                    document.getElementById('confirm-delete-modal').classList.remove('hidden');
                };
                
                div.innerHTML = `
                    <img src="${track.image}" alt="${track.title}" class="w-full aspect-square object-cover">
                    <div class="p-3">
                        <h3 class="font-medium truncate">${track.title}</h3>
                        <p class="text-sm text-gray-400 truncate">${track.artist}</p>
                    </div>
                `;
                
                div.appendChild(deleteBtn);
                container.appendChild(div);
            });
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            // Загрузка темы
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-theme');
                document.getElementById('theme-text').textContent = 'Темная тема';
                document.getElementById('theme-icon').innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            }
            
            // Загрузка трека из URL
            const urlParams = new URLSearchParams(window.location.search);
            const trackId = urlParams.get('track');
            
            if (trackId && tracks[trackId]) {
                openTrack(trackId);
            }
            
            // Обработчики событий
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            document.getElementById('volume-control').addEventListener('input', e => {
                audioPlayer.volume = e.target.value / 100;
            });
            
            document.getElementById('progress-bar').addEventListener('input', e => {
                const track = tracks[currentTrackId];
                if (!track) return;
                
                const seekTime = (e.target.value / 100) * track.duration;
                audioPlayer.currentTime = seekTime;
                
                document.getElementById('current-time').textContent = formatTime(seekTime);
                document.getElementById('player-current-time').textContent = formatTime(seekTime);
                document.getElementById('remaining-time').textContent = formatRemainingTime(seekTime, track.duration);
                document.getElementById('player-remaining-time').textContent = formatRemainingTime(seekTime, track.duration);
            });
            
            audioPlayer.addEventListener('timeupdate', () => {
                const track = tracks[currentTrackId];
                if (!track) return;
                
                const currentTime = audioPlayer.currentTime;
                const progress = (currentTime / track.duration) * 100;
                
                document.getElementById('progress-bar').value = progress;
                document.getElementById('current-time').textContent = formatTime(currentTime);
                document.getElementById('player-current-time').textContent = formatTime(currentTime);
                document.getElementById('remaining-time').textContent = formatRemainingTime(currentTime, track.duration);
                document.getElementById('player-remaining-time').textContent = formatRemainingTime(currentTime, track.duration);
                
                updateLyrics();
            });
            
            audioPlayer.addEventListener('ended', () => {
                isPlaying = false;
                updatePlayButton();
                updateFullscreenPlayButton();
                
                document.getElementById('progress-bar').value = 0;
                document.getElementById('current-time').textContent = '00:00';
                document.getElementById('player-current-time').textContent = '00:00';
                document.getElementById('remaining-time').textContent = `Осталось: -${formatTime(tracks[currentTrackId].duration)}`;
                document.getElementById('player-remaining-time').textContent = `Осталось: -${formatTime(tracks[currentTrackId].duration)}`;
                
                playNextTrack();
            });
            
            audioPlayer.addEventListener('play', () => {
                isPlaying = true;
                updatePlayButton();
                updateFullscreenPlayButton();
            });
            
            audioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                updatePlayButton();
                updateFullscreenPlayButton();
            });
            
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape' && isFullscreenLyrics) {
                    toggleFullscreenLyrics();
                } else if (e.key === 'Escape' && !document.getElementById('create-playlist-modal').classList.contains('hidden')) {
                    closeCreatePlaylistModal();
                } else if (e.key === 'Escape' && !document.getElementById('add-to-playlist-modal').classList.contains('hidden')) {
                    closeAddToPlaylistModal();
                } else if (e.key === 'Escape' && !document.getElementById('share-modal').classList.contains('hidden')) {
                    closeShareModal();
                } else if (e.key === 'Escape' && !document.getElementById('upload-modal').classList.contains('hidden')) {
                    closeUploadModal();
                } else if (e.key === 'Escape' && !document.getElementById('confirm-delete-modal').classList.contains('hidden')) {
                    closeDeleteModal();
                } else if (e.code === 'Space' && currentTrackId) {
                    e.preventDefault();
                    togglePlay();
                }
            });
            
            // Обработка касаний для мобильных устройств
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            audioPlayer.volume = 0.5;
            updatePlaylistsGrid();
            updateTracksGrid();
            updateAutoplayButton();
            updateLoopButton();
        });

        // Обработка формы загрузки
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('track-title-input').value.trim();
            const artist = document.getElementById('track-artist-input').value.trim();
            const duration = parseInt(document.getElementById('track-duration-input').value);
            const audioUrl = document.getElementById('audio-url-input').value.trim();
            const imageUrl = document.getElementById('image-url-input').value.trim();
            const lyrics = document.getElementById('track-lyrics-input').value.trim();
            const translation = document.getElementById('track-translation-input').value.trim();
            
            if (!title || !artist || !duration || !audioUrl) {
                alert('Пожалуйста, заполните название трека, исполнителя, продолжительность и ссылку на аудио');
                return;
            }
            
            if (duration <= 0) {
                alert('Продолжительность должна быть положительным числом');
                return;
            }
            
            // Проверка валидности URL
            try {
                new URL(audioUrl);
            } catch (e) {
                alert('Некорректная ссылка на аудио. Пожалуйста, введите правильный URL');
                return;
            }
            
            if (imageUrl) {
                try {
                    new URL(imageUrl);
                } catch (e) {
                    alert('Некорректная ссылка на изображение. Пожалуйста, введите правильный URL');
                    return;
                }
            }
            
            const trackData = {
                title: title,
                artist: artist,
                duration: duration,
                audioUrl: audioUrl,
                image: imageUrl,
                lyrics: processLyrics(lyrics),
                translation: translation
            };
            
            const trackId = addTrackToLibrary(trackData);
            closeUploadModal();
            alert(`Трек "${title}" успешно добавлен в библиотеку!`);
            openTrack(trackId);
        });
    </script>
</body>
</html>
